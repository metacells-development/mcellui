---
phase: 08-advanced-components
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/registry/ui/image-gallery.tsx
  - apps/demo/components/demos/image-gallery-demo.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Grid images show Skeleton placeholder while loading"
    - "Individual image load states are tracked independently"
    - "Fullscreen viewer shows loading indicator for large images"
    - "Demo demonstrates skeleton states during async load"
  artifacts:
    - path: "packages/registry/ui/image-gallery.tsx"
      provides: "ImageGallery with async loading state handling"
      contains: "onLoadStart"
    - path: "packages/registry/ui/image-gallery.tsx"
      provides: "Skeleton integration for loading placeholders"
      contains: "Skeleton"
    - path: "apps/demo/components/demos/image-gallery-demo.tsx"
      provides: "Demo section showing skeleton loading states"
      contains: "Loading States"
  key_links:
    - from: "packages/registry/ui/image-gallery.tsx"
      to: "Skeleton component"
      via: "import and render during loading"
      pattern: "import.*Skeleton"
    - from: "packages/registry/ui/image-gallery.tsx"
      to: "Image onLoadEnd"
      via: "state tracking per image"
      pattern: "onLoadEnd.*setLoadedImages"
---

<objective>
Add async loading state handling to ImageGallery component.

Purpose: Close verification gap for Success Criterion 4 ("Image Gallery handles async loading with skeleton states"). Currently, images load with no visual feedback, creating poor UX on slow connections.

Output: ImageGallery component with per-image loading state tracking, Skeleton placeholder integration, and demo section demonstrating loading behavior.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-advanced-components/08-VERIFICATION.md

# Reference files
@packages/registry/ui/image-gallery.tsx
@packages/registry/ui/skeleton.tsx
@packages/registry/ui/search-input.tsx
@apps/demo/components/demos/image-gallery-demo.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add loading state tracking to ImageGallery component</name>
  <files>packages/registry/ui/image-gallery.tsx</files>
  <action>
Add per-image loading state tracking and Skeleton integration to ImageGallery:

1. **Import Skeleton component** (line ~65):
   - Add: `import { Skeleton } from './skeleton';`
   - Keep existing imports (useTheme, haptic, imageGalleryTokens)

2. **Add loading state to ImageGallery component** (around line 349):
   - Add useState to track loaded images: `const [loadedImages, setLoadedImages] = useState<Set<number>>(new Set());`
   - This tracks which images have finished loading by index

3. **Update renderItem in ImageGallery** (lines 371-399):
   - Add `onLoadEnd` handler to Image: `onLoadEnd={() => setLoadedImages(prev => new Set([...prev, index]))}`
   - Wrap Image in a View container
   - Conditionally render Skeleton when image not yet loaded:
     ```tsx
     const isLoaded = loadedImages.has(index);
     return (
       <Pressable ...>
         {!isLoaded && (
           <Skeleton
             width={imageSize}
             height={imageSize / aspectRatio}
             radius="sm"
             style={{ position: 'absolute', top: 0, left: 0 }}
           />
         )}
         <Image
           source={{ uri: item.thumbnail || item.uri }}
           style={[
             styles.gridImage,
             { borderRadius: borderRadius || radius.sm },
             !isLoaded && { opacity: 0 }
           ]}
           onLoadEnd={() => setLoadedImages(prev => new Set([...prev, index]))}
         />
       </Pressable>
     );
     ```

4. **Add loading indicator to FullscreenViewer** (around line 220):
   - Add per-image loading state: `const [fullscreenLoaded, setFullscreenLoaded] = useState<Set<number>>(new Set());`
   - In renderImage, add ActivityIndicator overlay when image loading:
     ```tsx
     const isLoaded = fullscreenLoaded.has(images.indexOf(item));
     // ... existing AnimatedImage ...
     {!isLoaded && (
       <ActivityIndicator
         size="large"
         color={colors.background}
         style={{ position: 'absolute' }}
       />
     )}
     ```
   - Add `onLoadEnd` to AnimatedImage

5. **Import ActivityIndicator** from react-native (line ~42):
   - Add ActivityIndicator to the react-native import

6. **Add error state handling** (optional enhancement):
   - Add `onError` handler to Image components
   - Track errored images in separate state if desired
   - For now, focus on loading states (error handling can be future enhancement)

Reference SearchInput pattern (line 244) for ActivityIndicator usage.
Reference Skeleton component API: width, height, radius props.
  </action>
  <verify>
    - TypeScript compiles: `cd packages/registry && npx tsc --noEmit`
    - Grep confirms Skeleton import: `grep -n "import.*Skeleton" packages/registry/ui/image-gallery.tsx`
    - Grep confirms onLoadEnd handler: `grep -n "onLoadEnd" packages/registry/ui/image-gallery.tsx`
    - Grep confirms loadedImages state: `grep -n "loadedImages" packages/registry/ui/image-gallery.tsx`
  </verify>
  <done>
    - ImageGallery imports Skeleton component
    - Grid images track loading state per-image via useState
    - Grid images show Skeleton placeholder while loading (opacity: 0 on Image until loaded)
    - Fullscreen viewer shows ActivityIndicator while large images load
    - onLoadEnd handlers wire state updates to Image components
  </done>
</task>

<task type="auto">
  <name>Task 2: Add loading states demo section to ImageGalleryDemo</name>
  <files>apps/demo/components/demos/image-gallery-demo.tsx</files>
  <action>
Add a new "Loading States" section to demonstrate skeleton loading behavior:

1. **Add new section after "Grid Layouts"** (around line 48):
   ```tsx
   <Section title="Loading States">
     <View style={{ gap: spacing[4] }}>
       <View>
         <Text style={labelStyle}>Skeleton Placeholders</Text>
         <Text style={hintStyle}>
           Images show skeleton animation while loading from remote URLs
         </Text>
         <View style={{ marginHorizontal: -spacing[4], marginTop: spacing[2] }}>
           <ImageGallery
             images={SAMPLE_IMAGES.slice(0, 6)}
             columns={3}
             spacing={4}
           />
         </View>
       </View>
     </View>
   </Section>
   ```

2. **Add hint text explaining behavior** after the gallery in "Use Cases" section:
   - Update "Photo Album" hint to mention: "Skeleton placeholders shown while images load."

3. **Consider adding slow-loading demo** (optional):
   - Could add larger images (w=1200 instead of w=400) to make loading visible
   - Or add comment explaining that skeleton is visible on slow connections

The key is documenting the loading behavior exists. On fast connections, skeletons may flash briefly. The demo proves the feature works.

Follow existing demo patterns:
- Use Section component for grouping
- Use labelStyle and hintStyle for text
- Use spacing tokens (spacing[4], spacing[2])
- Negative margin pattern for full-width galleries
  </action>
  <verify>
    - Demo app compiles: `cd apps/demo && npx expo export --platform ios --output-dir /tmp/demo-check`
    - Grep confirms Loading States section: `grep -n "Loading States" apps/demo/components/demos/image-gallery-demo.tsx`
    - Grep confirms skeleton mention in hints: `grep -i "skeleton" apps/demo/components/demos/image-gallery-demo.tsx`
  </verify>
  <done>
    - Demo has "Loading States" section explaining skeleton behavior
    - Hint text documents that skeletons appear during image loading
    - Demo follows existing Section/labelStyle/hintStyle patterns
    - Demo compiles without errors
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Component verification:**
   - `grep -n "Skeleton" packages/registry/ui/image-gallery.tsx` shows import and usage
   - `grep -n "onLoadEnd" packages/registry/ui/image-gallery.tsx` shows handlers on Image components
   - `grep -n "loadedImages" packages/registry/ui/image-gallery.tsx` shows state tracking

2. **Demo verification:**
   - `grep -n "Loading States" apps/demo/components/demos/image-gallery-demo.tsx` shows new section
   - `grep -i "skeleton" apps/demo/components/demos/image-gallery-demo.tsx` shows documentation

3. **Build verification:**
   - Registry TypeScript compiles without errors
   - Demo app exports without errors

4. **Manual verification (optional):**
   - Run demo app on slow network to observe skeleton placeholders
   - Open fullscreen viewer to see loading indicator on large images
</verification>

<success_criteria>
Gap closure complete when:
1. ImageGallery component imports and uses Skeleton for loading placeholders
2. Per-image loading state tracked via useState and onLoadEnd handlers
3. Grid images show Skeleton while loading, real image when loaded
4. Fullscreen viewer shows ActivityIndicator while large images load
5. Demo has "Loading States" section documenting the behavior
6. Both packages compile without TypeScript errors
7. Success Criterion 4 from VERIFICATION.md now passes: "Image Gallery handles async loading with skeleton states"
</success_criteria>

<output>
After completion, create `.planning/phases/08-advanced-components/08-07-SUMMARY.md`
</output>

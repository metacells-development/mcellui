---
phase: 04-progress-loading
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/registry/ui/progress.tsx
  - packages/registry/ui/circular-progress.tsx
autonomous: true

must_haves:
  truths:
    - "Progress uses progressTokens for height per size variant"
    - "CircularProgress uses circularProgressTokens for size/stroke/label"
    - "CircularProgress respects areAnimationsDisabled() for reduce-motion"
    - "No hardcoded size values remain in either component"
  artifacts:
    - path: "packages/registry/ui/progress.tsx"
      provides: "Token-based Progress component"
      contains: "progressTokens"
    - path: "packages/registry/ui/circular-progress.tsx"
      provides: "Token-based CircularProgress with reduce-motion support"
      contains: "circularProgressTokens"
  key_links:
    - from: "packages/registry/ui/progress.tsx"
      to: "@metacells/mcellui-core"
      via: "import progressTokens"
      pattern: "import.*progressTokens.*from"
    - from: "packages/registry/ui/circular-progress.tsx"
      to: "@metacells/mcellui-core"
      via: "import circularProgressTokens, areAnimationsDisabled"
      pattern: "import.*circularProgressTokens.*from"
---

<objective>
Migrate Progress and CircularProgress components to use centralized tokens and ensure accessibility compliance.

Purpose: Replace hardcoded magic numbers with theme-based tokens. Add reduce-motion support to CircularProgress for accessibility compliance.

Output: Updated Progress and CircularProgress components consuming tokens from @metacells/mcellui-core
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-progress-loading/04-RESEARCH.md
@packages/registry/ui/progress.tsx
@packages/registry/ui/circular-progress.tsx
@packages/core/src/theme/components.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Progress to use progressTokens</name>
  <files>packages/registry/ui/progress.tsx</files>
  <action>
Update Progress component to consume centralized tokens:

1. Add import for progressTokens and PROGRESS_CONSTANTS:
```typescript
import { useTheme, areAnimationsDisabled, progressTokens, PROGRESS_CONSTANTS } from '@metacells/mcellui-core';
```

2. Remove the hardcoded sizeMap:
- Delete `sizeMap` constant (lines 50-54)

3. Update component to use tokens for height:
```typescript
const height = progressTokens[size].height;
```

4. Update animation durations to use tokens:
```typescript
useEffect(() => {
  if (!indeterminate) {
    if (animationsEnabled) {
      progress.value = withTiming(percentage, {
        duration: progressTokens.animation.determinateDuration,
        easing: Easing.out(Easing.ease),
      });
    } else {
      progress.value = percentage;
    }
  }
}, [percentage, indeterminate, animationsEnabled]);

useEffect(() => {
  if (indeterminate && animationsEnabled) {
    indeterminateProgress.value = withRepeat(
      withSequence(
        withTiming(1, { duration: progressTokens.animation.indeterminateDuration, easing: Easing.inOut(Easing.ease) }),
        withTiming(0, { duration: progressTokens.animation.indeterminateDuration, easing: Easing.inOut(Easing.ease) })
      ),
      -1,
      false
    );
  }
}, [indeterminate, animationsEnabled]);
```

5. Update indeterminate style to use PROGRESS_CONSTANTS:
```typescript
const indeterminateStyle = useAnimatedStyle(() => ({
  width: `${PROGRESS_CONSTANTS.indeterminateWidth}%`,
  left: `${indeterminateProgress.value * (100 - PROGRESS_CONSTANTS.indeterminateWidth)}%`,
}));
```

6. Update fallback colors:
```typescript
const getFillColor = (): string => {
  switch (color) {
    case 'primary':
      return colors.primary;
    case 'success':
      return colors.success ?? PROGRESS_CONSTANTS.fallbackColors.success;
    case 'warning':
      return colors.warning ?? PROGRESS_CONSTANTS.fallbackColors.warning;
    case 'destructive':
      return colors.destructive;
    case 'default':
    default:
      return colors.foreground;
  }
};
```

Keep existing accessibility props and structure - just replace hardcoded values.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/registry to verify no TypeScript errors.
Grep for "progressTokens" in progress.tsx to confirm import exists.
Verify no hardcoded 4, 8, 12 height values remain.
Verify no hardcoded 300, 1000 duration values remain.
  </verify>
  <done>
Progress component uses progressTokens for heights and animation durations, PROGRESS_CONSTANTS for indeterminate width and fallback colors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate CircularProgress to use circularProgressTokens with reduce-motion</name>
  <files>packages/registry/ui/circular-progress.tsx</files>
  <action>
Update CircularProgress component to consume centralized tokens and add reduce-motion support:

1. Add imports:
```typescript
import { useTheme, areAnimationsDisabled, circularProgressTokens } from '@metacells/mcellui-core';
```

2. Remove the hardcoded SIZE_CONFIG:
- Delete `SIZE_CONFIG` constant (lines 83-87)

3. Add reduce-motion check at component start:
```typescript
export function CircularProgress({
  // ... props
}: CircularProgressProps) {
  const { colors } = useTheme();
  const animationsEnabled = useMemo(() => !areAnimationsDisabled(), []);

  // Resolve size config from tokens
  const config = typeof size === 'number'
    ? { size, strokeWidth: customStrokeWidth ?? Math.max(4, size / 10), labelSize: Math.max(10, size / 5) }
    : circularProgressTokens[size];
```

4. Update animation effects to respect reduce-motion:
```typescript
// Update progress animation
useEffect(() => {
  if (!indeterminate) {
    if (animationsEnabled) {
      progress.value = withSpring(clampedValue / 100, {
        damping: circularProgressTokens.animation.springDamping,
        stiffness: circularProgressTokens.animation.springStiffness,
      });
    } else {
      progress.value = clampedValue / 100;
    }
  }
}, [clampedValue, indeterminate, animationsEnabled]);

// Indeterminate rotation animation
useEffect(() => {
  if (indeterminate && animationsEnabled) {
    rotation.value = withRepeat(
      withTiming(360, { duration: circularProgressTokens.animation.rotationDuration, easing: Easing.linear }),
      -1,
      false
    );
    indeterminateProgress.value = withRepeat(
      withTiming(0.75, { duration: circularProgressTokens.animation.rotationDuration, easing: Easing.inOut(Easing.ease) }),
      -1,
      true
    );
  } else if (!indeterminate) {
    if (animationsEnabled) {
      rotation.value = withTiming(0, { duration: 200 });
    } else {
      rotation.value = 0;
    }
  }
}, [indeterminate, animationsEnabled]);
```

5. For non-animated state (reduce-motion), set static values:
```typescript
const animatedProps = useAnimatedProps(() => {
  const progressValue = indeterminate
    ? (animationsEnabled ? indeterminateProgress.value : 0.5)
    : progress.value;
  const strokeDashoffset = circumference * (1 - progressValue);
  return {
    strokeDashoffset: clockwise ? strokeDashoffset : -strokeDashoffset,
  };
});
```

Keep existing SVG structure, label rendering, and accessibility - just replace hardcoded values and add reduce-motion support.
  </action>
  <verify>
Run `npx tsc --noEmit` in packages/registry to verify no TypeScript errors.
Grep for "circularProgressTokens" in circular-progress.tsx to confirm import exists.
Grep for "areAnimationsDisabled" to confirm reduce-motion check exists.
Verify no hardcoded SIZE_CONFIG values (40, 64, 96) remain.
Verify no hardcoded 1200 duration value remains outside token reference.
  </verify>
  <done>
CircularProgress component uses circularProgressTokens for size configs and animation settings, respects areAnimationsDisabled() for reduce-motion accessibility.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes: `cd packages/registry && npx tsc --noEmit`
2. Token imports visible: grep for imports from @metacells/mcellui-core in both files
3. Reduce-motion support: grep for areAnimationsDisabled in circular-progress.tsx
4. No hardcoded sizes: grep for magic numbers should not appear as literals
5. Demo app runs: Start demo app and verify Progress/CircularProgress still render correctly
</verification>

<success_criteria>
- Progress imports and uses progressTokens for heights (sm/md/lg)
- Progress uses progressTokens.animation for duration values
- Progress uses PROGRESS_CONSTANTS for indeterminate width and fallback colors
- CircularProgress imports and uses circularProgressTokens for size configs
- CircularProgress uses areAnimationsDisabled() check for reduce-motion
- CircularProgress falls back to static values when animations disabled
- Both components maintain existing accessibility props
</success_criteria>

<output>
After completion, create `.planning/phases/04-progress-loading/04-03-SUMMARY.md`
</output>

---
phase: 16-mcp-server-tool-quality
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - packages/mcp-server/src/tools/index.ts
autonomous: true

must_haves:
  truths:
    - "All error responses include isError: true flag"
    - "All error responses include a 'Next step:' hint for agent recovery"
    - "Registry load failure returns actionable error with possible causes"
    - "Component not found errors list available components and suggest mcellui_list_components"
    - "handleToolCall return type includes optional isError boolean"
    - "suggest_component respects maxResults parameter"
  artifacts:
    - path: "packages/mcp-server/src/tools/index.ts"
      provides: "Error recovery in all tool handlers + response improvements"
      contains: "isError: true"
  key_links:
    - from: "packages/mcp-server/src/tools/index.ts"
      to: "MCP protocol"
      via: "isError flag in tool response"
      pattern: "isError.*true"
---

<objective>
Add isError flags and actionable recovery hints to all MCP tool error paths. Improve response structure for agent consumption.

Purpose: When tools fail, agents need to know (1) it was an error (isError: true), and (2) what to do next (recovery hint). Without isError, agents may treat error text as valid output. Without hints, agents retry blindly or ask the user.

Output: Updated `handleToolCall` function in `packages/mcp-server/src/tools/index.ts` with isError flags on all error paths and structured recovery hints.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-mcp-server-tool-quality/16-RESEARCH.md
@.planning/phases/16-mcp-server-tool-quality/16-01-SUMMARY.md
@packages/mcp-server/src/tools/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isError and recovery hints to all error paths</name>
  <files>packages/mcp-server/src/tools/index.ts</files>
  <action>
Update the `handleToolCall` function with these changes:

**1. Update return type** to include optional `isError`:
```typescript
export async function handleToolCall(
  name: string,
  args: Record<string, unknown> | undefined
): Promise<{ content: Array<{ type: string; text: string }>; isError?: boolean }>
```

**2. Wrap entire function body** in try-catch for unexpected errors:
```typescript
try {
  // ... existing logic ...
} catch (error) {
  return {
    content: [{
      type: 'text',
      text: `Internal error: ${error instanceof Error ? error.message : 'Unknown error'}\n\nNext step: Report this issue or retry the tool call.`,
    }],
    isError: true,
  };
}
```

**3. Registry load failure** — add isError and recovery hint:
```
Could not load component registry.\n\nPossible causes:\n- Network connection issue\n- Registry URL unreachable: ${REGISTRY_URL}\n\nNext step: Check internet connection and retry. If running locally, ensure the registry directory exists.
```

**4. Component not found errors** (in get_component, get_component_source, add_component) — add isError and list hint:
```
Component "${componentName}" not found.\n\nAvailable: ${names}\n\nNext step: Use mcellui_list_components to browse all components, or mcellui_search to find by keyword.
```

**5. Code load failure** (in get_component, get_component_source) — add isError:
```
Could not load ${type} for "${componentName}".\n\nNext step: Try mcellui_get_component_source if documentation failed, or vice versa.
```

**6. No search results** (mcellui_search) — add isError: true:
Already has a hint text. Just add `isError: true`.

**7. No suggestions** (mcellui_suggest_component) — add isError: true:
Already has hint text. Just add `isError: true`.

**8. Unknown tool** — add isError: true and available tool names:
```
Unknown tool: "${name}".\n\nAvailable tools: mcellui_list_components, mcellui_get_component, mcellui_get_component_source, mcellui_add_component, mcellui_suggest_component, mcellui_create_component, mcellui_customize_theme, mcellui_doctor, mcellui_search
```

**9. suggest_component maxResults** — use args?.maxResults (from plan 01's schema addition):
Replace `const topSuggestions = suggestions.slice(0, 8);` with:
```typescript
const maxResults = Math.min(Math.max((args?.maxResults as number) || 5, 1), 10);
const topSuggestions = suggestions.slice(0, maxResults);
```

**Do NOT change** the `tools` array (already updated in plan 01), `componentKeywords`, or helper functions (parseComponentDocs, formatComponentDocs, etc.).
  </action>
  <verify>
Grep for `isError: true` in tools/index.ts — should find at least 7 occurrences (registry fail, 3x component-not-found, 2x code-load-fail, unknown-tool, no-search, no-suggestions, catch-all).
Grep for `Next step:` in tools/index.ts — should find recovery hints in all error paths.
Run `npx tsc --noEmit` from packages/mcp-server.
  </verify>
  <done>
All tool error responses include isError: true and a "Next step:" recovery hint. The handleToolCall return type declares isError as optional boolean. suggest_component respects maxResults. Requirements MCP-02 and MCP-03 are satisfied.
  </done>
</task>

</tasks>

<verification>
- `grep -c "isError: true" packages/mcp-server/src/tools/index.ts` returns >= 7
- `grep -c "Next step:" packages/mcp-server/src/tools/index.ts` returns >= 7
- `grep "maxResults" packages/mcp-server/src/tools/index.ts` appears in both schema and handler
- TypeScript compiles without errors
</verification>

<success_criteria>
Every error path in handleToolCall returns isError: true with a "Next step:" recovery hint. Agents can distinguish errors from results and know what to do next. Requirements MCP-02 and MCP-03 are satisfied.
</success_criteria>

<output>
After completion, create `.planning/phases/16-mcp-server-tool-quality/16-02-SUMMARY.md`
</output>

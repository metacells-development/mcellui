---
phase: 14-critical-package-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/core/package.json
  - packages/core/tsup.config.ts
autonomous: true

must_haves:
  truths:
    - "Core package exports compiled JavaScript (.js + .d.ts), not raw TypeScript"
    - "Users can import @metacells/mcellui-core without TypeScript configuration"
    - "Build command produces dist/ directory with compiled output"
  artifacts:
    - path: "packages/core/tsup.config.ts"
      provides: "TypeScript compilation configuration"
      contains: "defineConfig"
    - path: "packages/core/package.json"
      provides: "Package exports pointing to dist/"
      contains: "./dist/index.js"
  key_links:
    - from: "packages/core/package.json"
      to: "packages/core/dist/index.js"
      via: "exports field"
      pattern: '"default":\\s*"\\./dist/'
---

<objective>
Configure core package to compile TypeScript to JavaScript with type declarations.

Purpose: Users currently cannot use @metacells/mcellui-core because it exports raw .ts files that require TypeScript compilation. This breaks in JavaScript projects and production environments.

Output: tsup configuration file, updated package.json with build script and dist/ exports.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-critical-package-fixes/14-RESEARCH.md
@packages/core/package.json
@packages/cli/tsup.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tsup build configuration</name>
  <files>packages/core/tsup.config.ts</files>
  <action>
Create tsup.config.ts in packages/core/ with ESM-only build configuration:

```typescript
import { defineConfig } from 'tsup';

export default defineConfig({
  entry: ['src/index.ts'],
  format: ['esm'],
  dts: true,
  sourcemap: true,
  clean: true,
  treeshake: true,
  splitting: false,
  target: 'es2020',
  esbuildOptions(options) {
    options.platform = 'neutral';
  },
});
```

Key decisions (from CONTEXT.md + RESEARCH.md):
- ESM only (user decision - Expo/Metro ecosystem)
- Single entry point (existing pattern)
- Source maps enabled for debugging
- No source inclusion (compiled only with sourcemaps)

Also add tsup as devDependency to packages/core/package.json.
  </action>
  <verify>
Run `npm install` in packages/core, then `npm run build` should complete without errors.
File exists: packages/core/tsup.config.ts
  </verify>
  <done>tsup.config.ts exists and npm run build produces dist/ directory</done>
</task>

<task type="auto">
  <name>Task 2: Update package.json exports to dist/</name>
  <files>packages/core/package.json</files>
  <action>
Update packages/core/package.json to:

1. Change main/types to point to dist/:
   - "main": "./dist/index.js"
   - "types": "./dist/index.d.ts"

2. Update exports field to point to dist/:
   ```json
   "exports": {
     ".": {
       "types": "./dist/index.d.ts",
       "default": "./dist/index.js"
     },
     "./tokens": {
       "types": "./dist/tokens/index.d.ts",
       "default": "./dist/tokens/index.js"
     },
     "./utils": {
       "types": "./dist/utils/index.d.ts",
       "default": "./dist/utils/index.js"
     },
     "./package.json": "./package.json"
   }
   ```

3. Update files array:
   - "files": ["dist"]

4. Add sideEffects field:
   - "sideEffects": false

5. Add build scripts:
   ```json
   "scripts": {
     "build": "tsup",
     "dev": "tsup --watch",
     "prepublishOnly": "npm run build",
     "type-check": "tsc --noEmit",
     "lint": "eslint src/"
   }
   ```

Note: types condition MUST be first in exports (per RESEARCH.md).
Note: ./package.json export added for PKG-03.
  </action>
  <verify>
Run `npm run build` in packages/core - should produce:
- dist/index.js
- dist/index.d.ts

Run `npm pack --dry-run` in packages/core - should show only dist/ files (not src/).

Verify package.json has ./package.json export.
  </verify>
  <done>
package.json exports point to dist/, sideEffects is false, ./package.json export present, npm pack shows only dist files
  </done>
</task>

</tasks>

<verification>
1. Run `cd packages/core && npm install && npm run build` - should complete successfully
2. Check dist/ exists with index.js and index.d.ts
3. Run `npm pack --dry-run` - should show dist/ files, not src/
4. Verify package.json has:
   - main: ./dist/index.js
   - exports with types-first conditions
   - ./package.json export
   - sideEffects: false
</verification>

<success_criteria>
- Core package compiles to dist/ with JavaScript + declaration files
- Exports point to compiled output, not TypeScript source
- ./package.json export present for tooling
- sideEffects: false for tree-shaking
- prepublishOnly script ensures build before publish
</success_criteria>

<output>
After completion, create `.planning/phases/14-critical-package-fixes/14-01-SUMMARY.md`
</output>

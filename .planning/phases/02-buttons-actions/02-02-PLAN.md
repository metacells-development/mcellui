---
phase: 02-buttons-actions
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/registry/ui/icon-button.tsx
autonomous: true

must_haves:
  truths:
    - "IconButton uses centralized tokens from components.iconButton[size]"
    - "IconButton respects areAnimationsDisabled() for accessibility"
    - "IconButton uses componentRadius.iconButton for non-rounded, iconButtonRounded for rounded"
    - "IconButton uses BUTTON_CONSTANTS.disabledOpacity instead of hardcoded 0.5"
  artifacts:
    - path: "packages/registry/ui/icon-button.tsx"
      provides: "Token-based IconButton component"
      contains: "components.iconButton"
  key_links:
    - from: "packages/registry/ui/icon-button.tsx"
      to: "@metacells/mcellui-core"
      via: "import useTheme, areAnimationsDisabled, BUTTON_CONSTANTS"
      pattern: "areAnimationsDisabled"
---

<objective>
Migrate IconButton to use centralized tokens and add missing accessibility features.

Purpose: Ensure IconButton matches Button's gold standard patterns for consistency and accessibility
Output: Refactored IconButton using components.iconButton tokens, componentRadius, areAnimationsDisabled check
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-buttons-actions/02-RESEARCH.md
@.planning/phases/02-buttons-actions/02-01-SUMMARY.md
@packages/registry/ui/button.tsx
@packages/registry/ui/icon-button.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate IconButton to use centralized tokens</name>
  <files>packages/registry/ui/icon-button.tsx</files>
  <action>
Refactor IconButton to match Button's gold standard pattern:

1. **Update imports** - Add areAnimationsDisabled and BUTTON_CONSTANTS:
```typescript
import { useTheme, BUTTON_CONSTANTS, areAnimationsDisabled } from '@metacells/mcellui-core';
```

2. **Remove hardcoded sizeConfig** - Delete the local sizeConfig object (lines 72-77)

3. **Add useMemo for animations check** - Inside the component:
```typescript
const animationsEnabled = useMemo(() => !areAnimationsDisabled(), []);
```
(Add useMemo to React import)

4. **Replace useTheme destructuring** - Change to include components and componentRadius:
```typescript
const { colors, components, componentRadius, springs, platformShadow } = useTheme();
const tokens = components.iconButton[size];
```

5. **Update borderRadius calculation**:
```typescript
const borderRadiusValue = rounded
  ? componentRadius.iconButtonRounded
  : componentRadius.iconButton;
```

6. **Update handlePressIn** - Use BUTTON_CONSTANTS and respect animations:
```typescript
const handlePressIn = useCallback(
  (e: GestureResponderEvent) => {
    if (animationsEnabled) {
      scale.value = withSpring(0.9, springs.snappy);  // Keep 0.9 for prominent feedback
    }
    onPressIn?.(e);
  },
  [onPressIn, springs.snappy, animationsEnabled]
);
```

7. **Update handlePressOut** - Respect animations:
```typescript
const handlePressOut = useCallback(
  (e: GestureResponderEvent) => {
    if (animationsEnabled) {
      scale.value = withSpring(1, springs.snappy);
    }
    onPressOut?.(e);
  },
  [onPressOut, springs.snappy, animationsEnabled]
);
```

8. **Update animatedStyle** - Respect animations disabled:
```typescript
const animatedStyle = useAnimatedStyle(() => ({
  transform: [{ scale: animationsEnabled ? scale.value : 1 }],
}));
```

9. **Update disabled opacity** - Use BUTTON_CONSTANTS:
Replace `opacity: 0.5` with `opacity: BUTTON_CONSTANTS.disabledOpacity`

10. **Update styles** - Remove hardcoded `opacity: 0.5` from disabled style and use dynamic opacity in component

11. **Use tokens for size**:
```typescript
style={[
  styles.base,
  {
    width: tokens.size,
    height: tokens.size,
    borderRadius: borderRadiusValue,
  },
  // ... rest
]}
```

And for icon:
```typescript
React.cloneElement(icon as React.ReactElement<...>, {
  width: tokens.iconSize,
  height: tokens.iconSize,
  color: variantStyles.iconColor,
})
```
  </action>
  <verify>
1. `npx tsc --noEmit -p packages/registry/tsconfig.json` passes
2. Start demo app and verify IconButton demo works: all sizes render correctly, animations work, disabled state uses correct opacity
  </verify>
  <done>IconButton uses centralized tokens, respects areAnimationsDisabled(), uses componentRadius, uses BUTTON_CONSTANTS.disabledOpacity</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p packages/registry/tsconfig.json`
2. Demo verification: IconButton renders at all 4 sizes (sm, md, lg, xl)
3. Animation check: With iOS "Reduce Motion" enabled, animations should be disabled
4. Disabled state: Uses consistent 0.5 opacity from BUTTON_CONSTANTS
</verification>

<success_criteria>
- [ ] IconButton imports areAnimationsDisabled and BUTTON_CONSTANTS from core
- [ ] IconButton uses components.iconButton[size] for tokens
- [ ] IconButton uses componentRadius.iconButton / iconButtonRounded for border radius
- [ ] IconButton checks animationsEnabled before running animations
- [ ] IconButton uses BUTTON_CONSTANTS.disabledOpacity for disabled state
- [ ] Local sizeConfig removed
- [ ] TypeScript compilation passes
- [ ] Visual output unchanged (same sizes, same visual appearance)
</success_criteria>

<output>
After completion, create `.planning/phases/02-buttons-actions/02-02-SUMMARY.md`
</output>

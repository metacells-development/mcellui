---
phase: 03-feedback-components
plan: 04
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - packages/registry/ui/popover.tsx
  - packages/registry/ui/tooltip.tsx
autonomous: true

must_haves:
  truths:
    - "Popover uses POPOVER_CONSTANTS for offset, maxWidth, minWidth, and animation values"
    - "Tooltip uses TOOLTIP_CONSTANTS for padding, margin, arrow size, delay, and animation values"
    - "No hardcoded magic numbers in Popover and Tooltip"
  artifacts:
    - path: "packages/registry/ui/popover.tsx"
      provides: "Popover with centralized constants"
      contains: "POPOVER_CONSTANTS"
    - path: "packages/registry/ui/tooltip.tsx"
      provides: "Tooltip with centralized constants"
      contains: "TOOLTIP_CONSTANTS"
  key_links:
    - from: "packages/registry/ui/popover.tsx"
      to: "@metacells/mcellui-core"
      via: "import"
      pattern: "import.*POPOVER_CONSTANTS"
    - from: "packages/registry/ui/tooltip.tsx"
      to: "@metacells/mcellui-core"
      via: "import"
      pattern: "import.*TOOLTIP_CONSTANTS"
---

<objective>
Migrate Popover and Tooltip to use centralized constants for their magic numbers.

Purpose: Both positioning components have hardcoded values (offset, maxWidth, padding, arrow size, animation durations). Moving these to constants improves maintainability and consistency.

Output: Popover and Tooltip using centralized constants instead of hardcoded values.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-feedback-components/03-01-SUMMARY.md

@packages/registry/ui/popover.tsx
@packages/registry/ui/tooltip.tsx
@packages/core/src/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate Popover to POPOVER_CONSTANTS</name>
  <files>packages/registry/ui/popover.tsx</files>
  <action>
1. Add import for POPOVER_CONSTANTS:
   ```typescript
   import { useTheme, haptic, POPOVER_CONSTANTS } from '@metacells/mcellui-core';
   ```

2. In PopoverContent props defaults, replace hardcoded values:
   - `offset = 8` -> `offset = POPOVER_CONSTANTS.defaultOffset`
   - `maxWidth = 280` -> `maxWidth = POPOVER_CONSTANTS.defaultMaxWidth`

3. In styles.content, replace hardcoded minWidth:
   - `minWidth: 120` -> `minWidth: POPOVER_CONSTANTS.minWidth`

4. In the animation useEffect, replace hardcoded durations:
   - `withTiming(1, { duration: 150 })` -> `withTiming(1, { duration: POPOVER_CONSTANTS.animationDuration.in })`
   - `withSpring(1, { damping: 20, stiffness: 400 })` -> `withSpring(1, { damping: POPOVER_CONSTANTS.spring.damping, stiffness: POPOVER_CONSTANTS.spring.stiffness })`
   - `withTiming(0, { duration: 100 })` -> `withTiming(0, { duration: POPOVER_CONSTANTS.animationDuration.out })`

5. In getContentPosition, the margin value 8 is used for bounds checking:
   - `Math.max(8, Math.min(left, screenWidth - maxWidth - 8))`
   This uses the same margin value. Keep it as-is OR add POPOVER_CONSTANTS.margin if defined in 03-01.
   The important thing is consistency - if offset default is 8 and margin is 8, they may be the same conceptual value.

Note: Preserve the shadow styles - they should remain inline for platform shadow compatibility.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/registry` - no type errors.
Grep: `grep -E "offset = 8|maxWidth = 280|minWidth: 120|duration: 150|duration: 100" packages/registry/ui/popover.tsx` should return nothing except comments.
  </verify>
  <done>
Popover uses POPOVER_CONSTANTS for offset, maxWidth, minWidth, and animation values.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate Tooltip to TOOLTIP_CONSTANTS</name>
  <files>packages/registry/ui/tooltip.tsx</files>
  <action>
1. Add import for TOOLTIP_CONSTANTS:
   ```typescript
   import { useTheme, haptic, TOOLTIP_CONSTANTS } from '@metacells/mcellui-core';
   ```

2. Remove the internal constants (around lines 75-78):
   ```typescript
   // DELETE THESE:
   const TOOLTIP_PADDING = 12;
   const TOOLTIP_MARGIN = 8;
   const ARROW_SIZE = 8;
   ```

3. Replace all usages with TOOLTIP_CONSTANTS:
   - `TOOLTIP_PADDING` -> `TOOLTIP_CONSTANTS.padding`
   - `TOOLTIP_MARGIN` -> `TOOLTIP_CONSTANTS.margin`
   - `ARROW_SIZE` -> `TOOLTIP_CONSTANTS.arrowSize`

4. In Tooltip props defaults:
   - `delayMs = 500` -> `delayMs = TOOLTIP_CONSTANTS.defaultDelay`
   - `maxWidth = 250` -> `maxWidth = TOOLTIP_CONSTANTS.defaultMaxWidth`

5. In animation code, replace durations:
   - `withTiming(1, { duration: 150 })` -> `withTiming(1, { duration: TOOLTIP_CONSTANTS.animationDuration.in })`
   - `withTiming(0, { duration: 100 })` -> `withTiming(0, { duration: TOOLTIP_CONSTANTS.animationDuration.out })`
   - `withSpring(1, { damping: 20, stiffness: 300 })` - check if spring config should also be from constants

6. In calculatePosition function, update all references:
   - Uses TOOLTIP_MARGIN for screen bounds checking
   - Uses ARROW_SIZE for position calculations
   Ensure all references are updated.

7. In arrow styles, ARROW_SIZE is used for borderWidths:
   - `borderLeftWidth: ARROW_SIZE` -> `borderLeftWidth: TOOLTIP_CONSTANTS.arrowSize`
   - etc.
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/registry` - no type errors.
Grep: `grep -E "const TOOLTIP_PADDING|const TOOLTIP_MARGIN|const ARROW_SIZE|delayMs = 500|maxWidth = 250" packages/registry/ui/tooltip.tsx` should return nothing.
  </verify>
  <done>
Tooltip uses TOOLTIP_CONSTANTS for all magic numbers. No internal constants remain.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit -p packages/registry` passes
2. No hardcoded magic numbers in Popover
3. No internal constant definitions in Tooltip
4. Both components import and use their respective CONSTANTS
</verification>

<success_criteria>
- Popover imports and uses POPOVER_CONSTANTS
- Tooltip imports and uses TOOLTIP_CONSTANTS
- Internal magic numbers removed from both components
- Animation durations from constants
- Default prop values from constants
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-feedback-components/03-04-SUMMARY.md`
</output>

---
phase: 15-cli-audit
plan: 04
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - packages/cli/src/index.ts
  - packages/cli/src/commands/list.ts
autonomous: true

must_haves:
  truths:
    - "Commander.js uses configureOutput to route error output to stderr"
    - "program.parseAsync() is used instead of program.parse() for proper async error handling"
    - "list command supports --json flag for machine-readable output"
    - "All CLI help text is accurate and complete for every command"
    - "Unhandled async errors are caught and formatted consistently"
  artifacts:
    - path: "packages/cli/src/index.ts"
      provides: "Program setup with configureOutput, parseAsync, and global error handling"
    - path: "packages/cli/src/commands/list.ts"
      provides: "List command with --json flag support"
  key_links:
    - from: "packages/cli/src/index.ts"
      to: "commander"
      via: "program.configureOutput() and program.parseAsync()"
      pattern: "configureOutput|parseAsync"
    - from: "packages/cli/src/commands/list.ts"
      to: "JSON.stringify"
      via: "--json flag outputs structured data"
      pattern: "options\\.json.*JSON\\.stringify"
---

<objective>
Configure Commander.js for proper async error handling, add --json to list command, and verify all help text.

Purpose: The current `program.parse()` call doesn't handle async errors from command actions. `program.parseAsync()` properly catches and surfaces these. Additionally, the `list` command lacks `--json` output which is useful for CI/CD pipelines. This plan also audits all help text for accuracy.

Output: Updated index.ts with proper Commander configuration, list.ts with --json support, and verified help text.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cli-audit/15-01-SUMMARY.md
@packages/cli/src/index.ts
@packages/cli/src/commands/list.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure Commander.js output and async error handling</name>
  <files>packages/cli/src/index.ts</files>
  <action>
Rewrite `packages/cli/src/index.ts` to:

1. **Import handleError from utils/errors and chalk:**
```typescript
import { handleError } from './utils/errors';
import chalk from 'chalk';
```

2. **Configure Commander output streams:**
```typescript
program.configureOutput({
  writeOut: (str) => process.stdout.write(str),
  writeErr: (str) => process.stderr.write(str),
  outputError: (str, write) => write(chalk.red(str)),
});
```

3. **Replace `program.parse()` with an async main function:**
```typescript
async function main() {
  try {
    await program.parseAsync(process.argv);
  } catch (error) {
    handleError({
      message: error instanceof Error ? error.message : 'An unexpected error occurred',
      hint: 'If this persists, run: npx mcellui doctor',
    });
  }
}

main();
```

This ensures:
- Commander's built-in help/version output goes to stdout
- Commander's error messages go to stderr
- Unhandled async rejections from command actions are caught
- Unexpected errors get actionable hints

Keep all existing imports and program.addCommand() calls unchanged.
  </action>
  <verify>
1. Check index.ts contains `configureOutput`
2. Check index.ts contains `parseAsync`
3. Check index.ts contains `main()` async function
4. Verify no `program.parse()` (without Async) remains
  </verify>
  <done>
index.ts uses configureOutput for stderr/stdout separation and parseAsync for proper async error handling. Unhandled errors get formatted consistently with actionable hints.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --json flag to list command and verify all help text</name>
  <files>packages/cli/src/commands/list.ts</files>
  <action>
**Add --json flag to list command:**

1. Add `.option('--json', 'Output as JSON')` to the list command options

2. In `listAvailableComponents()`: Accept json option. If `options.json`, output the registry items as JSON instead of formatted text:
```typescript
if (options.json) {
  const items = options.category
    ? registry.filter(item => (item.category || 'Other').toLowerCase() === options.category.toLowerCase())
    : registry;
  console.log(JSON.stringify(items, null, 2));
  return;
}
```

3. In `listInstalledComponents()`: Accept json option. If `options.json`, output the installed status array as JSON:
```typescript
if (options.json) {
  console.log(JSON.stringify(installed, null, 2));
  return;
}
```

4. Update the function signatures to accept the json option in the options type.

5. Update the action handler to pass `options.json` to both functions.

**Verify all help text across all commands:**

Review and ensure these help texts are accurate (they should be, based on code review — this is a verification step):
- init: "Initialize mcellui in your project" - correct
- add: "Add a component to your project" - correct
- list: "List available or installed components" - correct
- doctor: "Check project setup and diagnose common issues" - correct
- diff: "Compare locally installed components against the registry source" - correct
- update: "Update installed components to latest registry versions" - correct
- create: "Scaffold a new custom component" - correct
- pick: "Interactively browse and select components to add" - correct

All flag descriptions should be present and accurate. If any are missing or unclear, update them. Specifically check:
- list: update description to mention JSON output: keep as is, the --json flag description handles it
- All --cwd flags: should say "Working directory" consistently - verify
  </action>
  <verify>
1. Run `npx mcellui list --help` (or check source) — should show --json flag
2. Check that JSON output produces valid JSON array
3. Verify all 8 commands have accurate help text and flag descriptions
  </verify>
  <done>
list command supports --json for both available and installed output. All help text across 8 commands verified accurate. All flag descriptions present and consistent.
  </done>
</task>

</tasks>

<verification>
1. index.ts uses `configureOutput` and `parseAsync`
2. list command has `--json` flag that outputs valid JSON
3. Unhandled async errors from commands are caught and formatted
4. All 8 commands have accurate help text
5. All --cwd flags have consistent "Working directory" description
</verification>

<success_criteria>
- Commander.js properly configured for stderr/stdout separation
- Async errors caught and formatted with actionable hints
- list --json produces structured JSON output for both available and installed modes
- All CLI help text verified accurate and complete
</success_criteria>

<output>
After completion, create `.planning/phases/15-cli-audit/15-04-SUMMARY.md`
</output>

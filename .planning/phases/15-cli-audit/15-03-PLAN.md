---
phase: 15-cli-audit
plan: 03
type: execute
wave: 2
depends_on: ["15-01", "15-02"]
files_modified:
  - packages/cli/src/commands/init.ts
  - packages/cli/src/commands/add.ts
  - packages/cli/src/commands/list.ts
  - packages/cli/src/commands/doctor.ts
  - packages/cli/src/commands/diff.ts
  - packages/cli/src/commands/update.ts
  - packages/cli/src/commands/create.ts
  - packages/cli/src/commands/pick.ts
autonomous: true

must_haves:
  truths:
    - "Every CLI error across all 8 commands is written to stderr via handleError() or logError()"
    - "No command uses console.log(chalk.red(...)) for errors anymore"
    - "Every error message includes an actionable hint"
    - "Exit code is 1 for all error paths across all commands"
    - "Prompt cancellation (Ctrl+C) exits gracefully with exit code 0"
    - "Partial failures (add/update with multiple components) exit with code 1 if any failed"
  artifacts:
    - path: "packages/cli/src/commands/init.ts"
      provides: "Init command with centralized error handling"
    - path: "packages/cli/src/commands/add.ts"
      provides: "Add command with centralized error handling and partial failure exit code"
    - path: "packages/cli/src/commands/list.ts"
      provides: "List command with centralized error handling"
    - path: "packages/cli/src/commands/doctor.ts"
      provides: "Doctor command with stderr for errors"
    - path: "packages/cli/src/commands/diff.ts"
      provides: "Diff command with centralized error handling"
    - path: "packages/cli/src/commands/update.ts"
      provides: "Update command with centralized error handling and partial failure exit code"
    - path: "packages/cli/src/commands/create.ts"
      provides: "Create command with centralized error handling"
    - path: "packages/cli/src/commands/pick.ts"
      provides: "Pick command with centralized error handling and proper exit codes"
  key_links:
    - from: "packages/cli/src/commands/*.ts"
      to: "packages/cli/src/utils/errors.ts"
      via: "import { handleError, errors } from '../utils/errors'"
      pattern: "import.*errors.*from.*utils/errors"
---

<objective>
Refactor all 8 CLI commands to use the centralized error handling utilities created in Plan 01.

Purpose: Currently all commands use `console.log(chalk.red(...)); process.exit(1)` for errors, which writes to stdout. This refactors every error path to use `handleError()` and `errors.*` factories, ensuring consistent stderr output, actionable hints, and proper exit codes.

Output: All 8 command files updated with consistent error handling patterns.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-cli-audit/15-01-SUMMARY.md
@.planning/phases/15-cli-audit/15-02-SUMMARY.md
@packages/cli/src/utils/errors.ts
@packages/cli/src/commands/init.ts
@packages/cli/src/commands/add.ts
@packages/cli/src/commands/list.ts
@packages/cli/src/commands/doctor.ts
@packages/cli/src/commands/diff.ts
@packages/cli/src/commands/update.ts
@packages/cli/src/commands/create.ts
@packages/cli/src/commands/pick.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor init, add, list, and doctor commands</name>
  <files>packages/cli/src/commands/init.ts, packages/cli/src/commands/add.ts, packages/cli/src/commands/list.ts, packages/cli/src/commands/doctor.ts</files>
  <action>
For each command, apply these changes:

**All commands - common patterns to replace:**

1. Replace `console.log(chalk.red('Could not find a valid project.'));` + `console.log(chalk.dim('Run...'));` + `process.exit(1)` with: `errors.noProject()`

2. Replace `console.log(chalk.red('Project not initialized.'));` + `console.log(chalk.dim('Run...'));` + `process.exit(1)` with: `errors.notInitialized()`

3. Replace catch blocks that do `spinner.fail('Failed...'); console.error(error); process.exit(1)` with: `spinner.fail('...'); handleError({ message: '...', hint: '...' })` - keep spinner.fail for visual feedback, but use handleError for the error message and exit.

4. Add prompt cancellation handling: after every `await prompts(...)` call, check if the response value is undefined and exit gracefully: `if (response.value === undefined) { process.exit(0); }` — use `process.exit(0)` because user-initiated cancellation is not an error.

**Import changes for all files:** Add `import { handleError, errors } from '../utils/errors';`

**init.ts specifics:**
- Line 21-25: Replace no-project error with `errors.noProject()`
- Line 211-215 catch: Replace with `spinner.fail('Failed to initialize'); handleError({ message: 'Initialization failed', hint: error instanceof Error ? error.message : 'Check file permissions and try again' })`
- After prompts call (line 59-83): Add cancellation check — if `response.componentsPath === undefined`, exit 0

**add.ts specifics:**
- Lines 27-31: Replace with `errors.noProject()`
- Lines 34-38: Replace with `errors.notInitialized()`
- Lines 45-47: Replace `console.log(chalk.red('No components found in registry.')); process.exit(1)` with `handleError({ message: 'No components found in registry', hint: 'Check your internet connection or try again later' })`
- Lines 62-64: After multiselect prompts, check cancellation
- Lines 125-127: After confirm prompt, check cancellation
- Lines 197-201 catch: Replace with handleError
- After the for loop (line 134-177): Track failure count. After the loop, if any components failed, call `process.exit(1)` at the end of the try block

**list.ts specifics:**
- Lines 65-69 (listAvailableComponents catch): Replace with handleError
- Lines 79-83 (listInstalledComponents no project): Replace with `errors.noProject()`
- Lines 87-91 (not initialized): Replace with `errors.notInitialized()`
- Lines 189-193 catch: Replace with handleError

**doctor.ts specifics:**
- Lines 599-603 (no project): Replace with `errors.noProject()`
- Lines 656-659 catch: Replace `console.error(chalk.red('Doctor check failed:'), error)` with `handleError({ message: 'Doctor check failed', hint: error instanceof Error ? error.message : 'Run again with --json for details' })`
- JSON output errors should still go to stdout (it's data output for JSON mode)
  </action>
  <verify>
1. Search all 4 files for `console.log(chalk.red(` — should find ZERO occurrences (except in templates/generated code)
2. Search for `import.*errors.*from.*utils/errors` — should find imports in all 4 files
3. Every `process.exit(1)` is either in handleError or after a tracked failure count
  </verify>
  <done>
init.ts, add.ts, list.ts, doctor.ts all use handleError() and errors.* for error output. No console.log(chalk.red(...)) remains for error messages. Prompt cancellations exit gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor diff, update, create, and pick commands</name>
  <files>packages/cli/src/commands/diff.ts, packages/cli/src/commands/update.ts, packages/cli/src/commands/create.ts, packages/cli/src/commands/pick.ts</files>
  <action>
Apply the same patterns as Task 1:

**Import changes for all files:** Add `import { handleError, errors } from '../utils/errors';`

**diff.ts specifics:**
- Lines 35-39: Replace with `errors.noProject()`
- Lines 42-46: Replace with `errors.notInitialized()`
- Lines 84-87: Replace spinner.fail + process.exit(1) with `spinner.stop(); handleError({ message: 'None of the specified components are installed', hint: 'Check component names: npx mcellui list --installed' })`
- Lines 192-196 catch: Replace with `spinner.stop(); handleError({ message: 'Failed to diff components', hint: error instanceof Error ? error.message : 'Check your network connection' })`
- Keep the exit code logic at lines 184 and 191 (exit 1 if changes found is intentional for CI/CD usage)

**update.ts specifics:**
- Lines 33-37: Replace with `errors.noProject()`
- Lines 39-44: Replace with `errors.notInitialized()`
- Lines 101-107: Add prompt cancellation check after confirm
- Lines 185-189 catch: Replace with handleError
- After the update loop: if `failCount > 0`, call `process.exit(1)` to indicate partial failure

**create.ts specifics:**
- Lines 33-37: Replace with `errors.noProject()`
- Lines 39-44: Replace with `errors.notInitialized()`
- Lines 55-59: Replace `console.log(chalk.red('Component already exists:...'))` + process.exit(1) with `handleError({ message: 'Component already exists: ' + fileName, hint: 'Choose a different name or delete the existing file', code: 'COMPONENT_EXISTS' })`
- Lines 72-82: Add prompt cancellation check
- Lines 102-106 catch: Replace with handleError

**pick.ts specifics (most important - currently returns instead of exiting on errors):**
- Lines 93-97: Replace `console.log(chalk.red(...)); return;` with `errors.noProject()` — this now properly exits with code 1 instead of silently returning
- Lines 101-104: Replace with `errors.notInitialized()`
- Lines 109-112: Replace `spinner.fail('Could not load registry'); return;` with `spinner.stop(); handleError({ message: 'Could not load component registry', hint: 'Check your internet connection and try again' })`
- Lines 152-155: Prompt cancellation check after category select
- Lines 187-189: After component multiselect, check cancellation
- Lines 207-209: After confirm prompt, check cancellation
- Lines 256-258 catch: Replace with `installSpinner.fail(...); handleError(...)` — actually, this is inside a per-component loop, so just use spinner.fail and continue. Track failures and exit 1 at end if any failed.
  </action>
  <verify>
1. Search all 4 files for `console.log(chalk.red(` — should find ZERO occurrences
2. Search for `import.*errors.*from.*utils/errors` — should find imports in all 4 files
3. pick.ts: verify that error paths call process.exit(1) via handleError, not just `return`
4. update.ts: verify partial failure exits with code 1
  </verify>
  <done>
diff.ts, update.ts, create.ts, pick.ts all use handleError() and errors.* for error output. pick.ts properly exits with code 1 on errors (was previously just returning). Prompt cancellations handled. Partial failures exit with code 1.
  </done>
</task>

</tasks>

<verification>
1. `grep -r "console.log(chalk.red" packages/cli/src/commands/` — zero matches
2. All 8 command files import from `../utils/errors`
3. pick.ts uses `errors.noProject()` and `errors.notInitialized()` instead of return
4. add.ts and update.ts exit with code 1 on partial failures
5. All prompts() calls have cancellation handling (check for undefined)
</verification>

<success_criteria>
- Zero console.log(chalk.red(...)) calls remain in any command file
- All 8 commands use handleError() or errors.* for error output
- All errors go to stderr with actionable hints
- Prompt cancellation exits with code 0
- Partial failures (add/update) exit with code 1
- pick command properly exits with code 1 on errors (not silent return)
</success_criteria>

<output>
After completion, create `.planning/phases/15-cli-audit/15-03-SUMMARY.md`
</output>

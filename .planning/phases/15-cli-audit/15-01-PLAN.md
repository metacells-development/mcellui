---
phase: 15-cli-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/utils/errors.ts
  - packages/cli/src/utils/output.ts
  - packages/cli/src/utils/index.ts
autonomous: true

must_haves:
  truths:
    - "All CLI errors are written to stderr, not stdout"
    - "Every error message includes an actionable hint telling the user what to do next"
    - "Error formatting is consistent across all commands (same prefix, same hint style)"
  artifacts:
    - path: "packages/cli/src/utils/errors.ts"
      provides: "Centralized error handling with handleError() and common error factories"
      exports: ["handleError", "errors", "CLIError"]
    - path: "packages/cli/src/utils/output.ts"
      provides: "Output utilities for stderr/stdout separation"
      exports: ["logError", "logWarning", "logInfo"]
    - path: "packages/cli/src/utils/index.ts"
      provides: "Barrel export including new utilities"
  key_links:
    - from: "packages/cli/src/utils/errors.ts"
      to: "process.stderr"
      via: "process.stderr.write() for all error output"
      pattern: "process\\.stderr\\.write"
    - from: "packages/cli/src/utils/index.ts"
      to: "packages/cli/src/utils/errors.ts"
      via: "re-export"
      pattern: "export.*from.*errors"
---

<objective>
Create centralized error handling and output utilities for the mcellui CLI.

Purpose: All 8 CLI commands currently use `console.log(chalk.red(...))` for errors, which writes to stdout instead of stderr. This plan creates shared utilities that enforce stderr output, consistent formatting, and actionable error messages. These utilities will be consumed by Plan 03 when refactoring all commands.

Output: Two new utility files (`errors.ts`, `output.ts`) and updated barrel export.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/cli/src/utils/index.ts
@packages/cli/src/utils/project.ts
@packages/cli/src/commands/init.ts
@packages/cli/src/commands/add.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized error handling utility</name>
  <files>packages/cli/src/utils/errors.ts</files>
  <action>
Create `packages/cli/src/utils/errors.ts` with:

1. **CLIError interface:**
```typescript
export interface CLIError {
  message: string;
  hint?: string;
  code?: string;
  exitCode?: number;
}
```

2. **handleError() function** that:
   - Writes error message to stderr using `process.stderr.write(chalk.red(...))`
   - Writes optional hint to stderr using `process.stderr.write(chalk.dim(...))`
   - Calls `process.exit(exitCode ?? 1)`
   - Return type is `never`
   - Format: blank line, red "Error: {message}", blank line + dim hint if present, blank line, exit

3. **Common error factory object `errors`** with methods:
   - `errors.noProject()` - "Could not find a valid Expo/React Native project" + hint "Run this command from a project directory containing package.json" + code NO_PROJECT
   - `errors.notInitialized()` - "Project not initialized" + hint "Run: npx mcellui init" + code NOT_INITIALIZED
   - `errors.registryFetch(cause?: string)` - "Failed to fetch component registry" + hint "Check your internet connection and try again" + code REGISTRY_FETCH_FAILED
   - `errors.componentNotFound(name: string)` - "Component \"{name}\" not found in registry" + hint "Run: npx mcellui list" + code COMPONENT_NOT_FOUND
   - `errors.configInvalid(detail?: string)` - "Invalid configuration" + hint with detail or "Check mcellui.config.ts" + code CONFIG_INVALID

All factory methods return `never` (they call handleError which calls process.exit).

Import chalk from 'chalk'. Use consistent formatting across all error outputs.
  </action>
  <verify>
Run: `npx tsx -e "import { handleError, errors } from './packages/cli/src/utils/errors.ts'; console.log('exports OK');"` from project root to verify the module exports correctly. TypeScript compilation check: `npx tsc --noEmit packages/cli/src/utils/errors.ts` (or just verify no syntax errors).
  </verify>
  <done>
errors.ts exists with handleError() writing to stderr, CLIError interface exported, and 5 common error factory methods. All error output uses process.stderr.write, not console.log.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create output utilities and update barrel export</name>
  <files>packages/cli/src/utils/output.ts, packages/cli/src/utils/index.ts</files>
  <action>
**Create `packages/cli/src/utils/output.ts`** with helper functions for consistent output:

1. **logError(message: string)** - writes chalk.red message to stderr
2. **logWarning(message: string)** - writes chalk.yellow message to stderr
3. **logInfo(message: string)** - writes chalk.dim message to stderr
4. **logSuccess(message: string)** - writes chalk.green message to stdout (success is data)

Each function writes a newline-terminated string. logError, logWarning, logInfo use `process.stderr.write()`. logSuccess uses `process.stdout.write()`.

Import chalk from 'chalk'.

**Update `packages/cli/src/utils/index.ts`** to re-export from both new modules:

```typescript
export { getProjectRoot, detectProjectType, getConfig, type NativeUIConfig } from './project';
export { getRegistry, fetchComponent, type RegistryItem, type ComponentData } from './registry';
export { handleError, errors, type CLIError } from './errors';
export { logError, logWarning, logInfo, logSuccess } from './output';
```
  </action>
  <verify>
Verify the barrel export works: check that `import { handleError, errors, logError } from './packages/cli/src/utils/index.ts'` resolves correctly. No TypeScript errors in the files.
  </verify>
  <done>
output.ts exists with 4 logging helpers using proper stderr/stdout separation. index.ts re-exports all utilities including the new error and output modules.
  </done>
</task>

</tasks>

<verification>
1. `packages/cli/src/utils/errors.ts` exists and exports handleError, errors, CLIError
2. `packages/cli/src/utils/output.ts` exists and exports logError, logWarning, logInfo, logSuccess
3. `packages/cli/src/utils/index.ts` re-exports both new modules
4. All error output uses process.stderr.write, not console.log
5. Every error factory includes a hint with actionable next step
</verification>

<success_criteria>
- Centralized error utility created with stderr output
- Common error factories cover the 5 most frequent CLI error patterns
- Output helpers provide consistent formatting for errors, warnings, and info
- All new exports available through barrel file
</success_criteria>

<output>
After completion, create `.planning/phases/15-cli-audit/15-01-SUMMARY.md`
</output>

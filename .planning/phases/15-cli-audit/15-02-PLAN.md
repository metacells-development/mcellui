---
phase: 15-cli-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/cli/src/utils/registry.ts
autonomous: true

must_haves:
  truths:
    - "Network failures are retried up to 3 times with exponential backoff before showing an error"
    - "Non-network errors (404, parse errors) are NOT retried"
    - "Fetch operations have a 30-second timeout"
  artifacts:
    - path: "packages/cli/src/utils/registry.ts"
      provides: "Registry fetch with retry logic, timeout, and better error handling"
      exports: ["getRegistry", "fetchComponent", "RegistryItem", "ComponentData"]
  key_links:
    - from: "packages/cli/src/utils/registry.ts"
      to: "fetch API"
      via: "fetchWithRetry wrapper"
      pattern: "fetchWithRetry"
---

<objective>
Add network retry logic, timeouts, and improved error handling to the registry utilities.

Purpose: The CLI currently has no retry logic for network failures. A single timeout or connection reset causes immediate failure. This plan adds exponential backoff retry for transient network errors and a 30-second timeout, making the CLI resilient on unreliable networks.

Output: Enhanced `registry.ts` with retry logic and better error propagation.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/cli/src/utils/registry.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fetch retry logic and timeout to registry utilities</name>
  <files>packages/cli/src/utils/registry.ts</files>
  <action>
Modify `packages/cli/src/utils/registry.ts` to add retry and timeout support. Keep all existing exports and interfaces unchanged.

**Add these internal helper functions (before the existing functions):**

1. **`sleep(ms: number): Promise<void>`** - simple Promise-based delay

2. **`isNetworkError(error: unknown): boolean`** - returns true if the error is a transient network error:
   - Check for error codes: ECONNRESET, ENOTFOUND, ETIMEDOUT, ECONNREFUSED, ECONNABORTED
   - Check for AbortError (from timeout)
   - Check `error.message` and `error.cause` for these codes
   - Return false for everything else (non-retryable)

3. **`fetchWithRetry(url: string, maxRetries = 3): Promise<Response>`** - wraps fetch with:
   - AbortController with 30-second timeout (`AbortSignal.timeout(30_000)`)
   - Loop for `maxRetries` attempts
   - On failure: if `isNetworkError(error)` and attempts remaining, wait with exponential backoff: `Math.min(1000 * 2^(attempt-1), 5000)` + random jitter (0-200ms)
   - On non-network errors or final attempt: throw the error
   - Clear timeout on success

**Modify `getRemoteRegistry()`:**
- Replace `fetch(...)` with `fetchWithRetry(...)`
- Instead of catching errors and returning `[]`, let errors propagate (callers will handle via handleError)
- Remove the `console.error('Failed to fetch remote registry:', error)` line
- Still catch and throw a more descriptive error: `throw new Error('Failed to fetch registry: ' + (error instanceof Error ? error.message : String(error)))`

**Modify `fetchRemoteComponent()`:**
- Replace `fetch(...)` with `fetchWithRetry(...)` for each file fetch
- Check response.ok before calling response.text() - throw if not ok (e.g., 404)

**Modify `getLocalRegistry()`:**
- Replace `console.error(...)` with throwing the error: `throw new Error('Failed to load local registry: ' + (error instanceof Error ? error.message : String(error)))`

DO NOT change any existing type exports (RegistryItem, Registry, ComponentData) or function signatures. Only enhance the internal fetch behavior.
  </action>
  <verify>
1. Verify the module still exports correctly: check that RegistryItem, ComponentData, getRegistry, fetchComponent are all exported
2. Verify TypeScript compiles without errors
3. Check that fetchWithRetry, isNetworkError, sleep are defined as internal functions (not exported)
  </verify>
  <done>
registry.ts has retry logic (3 retries, exponential backoff with jitter), 30s timeout via AbortSignal, and network error detection. Non-network errors (404, parse) are not retried. Errors propagate to callers instead of being silently caught and returning empty arrays.
  </done>
</task>

</tasks>

<verification>
1. `fetchWithRetry` function exists in registry.ts with retry loop and backoff
2. `isNetworkError` function correctly identifies transient network errors
3. All fetch calls use fetchWithRetry instead of raw fetch
4. 30-second timeout is configured via AbortSignal
5. Non-network errors are NOT retried
6. Errors propagate instead of being silently swallowed (no more returning [] on error)
</verification>

<success_criteria>
- Network requests have 3 retry attempts with exponential backoff
- 30-second timeout prevents hanging on unresponsive servers
- Only transient network errors trigger retries
- Errors propagate to callers for proper error display
</success_criteria>

<output>
After completion, create `.planning/phases/15-cli-audit/15-02-SUMMARY.md`
</output>

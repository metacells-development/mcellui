---
phase: 19-critical-color-api-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/registry/ui/calendar.tsx
  - packages/registry/ui/tag-input.tsx
  - packages/registry/ui/pagination.tsx
  - packages/registry/ui/tag-input.tsx
  - packages/registry/ui/tooltip.tsx
  - packages/registry/ui/segmented-control.tsx
  - packages/registry/ui/popover.tsx
  - packages/registry/ui/tabs.tsx
  - packages/registry/ui/slider.tsx
autonomous: true

must_haves:
  truths:
    - "All icon components in UI files use colors.foreground instead of hardcoded #000"
    - "All 6 shadow components use platformShadow() instead of custom shadow objects"
    - "Icons passed an explicit color prop still use that color (not overridden)"
  artifacts:
    - path: "packages/registry/ui/calendar.tsx"
      provides: "Icon components with semantic color defaults"
      contains: "colors.foreground"
    - path: "packages/registry/ui/tag-input.tsx"
      provides: "Icon with semantic default + platformShadow()"
      contains: "platformShadow"
    - path: "packages/registry/ui/tooltip.tsx"
      provides: "platformShadow() usage"
      contains: "platformShadow"
    - path: "packages/registry/ui/segmented-control.tsx"
      provides: "platformShadow() usage"
      contains: "platformShadow"
    - path: "packages/registry/ui/popover.tsx"
      provides: "platformShadow() usage"
      contains: "platformShadow"
    - path: "packages/registry/ui/tabs.tsx"
      provides: "platformShadow() usage"
      contains: "platformShadow"
    - path: "packages/registry/ui/slider.tsx"
      provides: "platformShadow() usage"
      contains: "platformShadow"
  key_links:
    - from: "packages/registry/ui/*.tsx"
      to: "@metacells/mcellui-core"
      via: "useTheme() hook"
      pattern: "const \\{ .*(colors|platformShadow).* \\} = useTheme"
---

<objective>
Fix icon color defaults and shadow implementations in UI components.

Purpose: UI components with hardcoded `#000` icon defaults are invisible in dark mode. Custom shadow objects bypass platform optimization and dark mode adaptation. Both must use semantic tokens.

Output: 3 UI icon files using `colors.foreground` default + 6 UI shadow files using `platformShadow()`.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-critical-color-api-fixes/19-RESEARCH.md

Key reference files:
@packages/core/src/theme/colors.ts (semantic color tokens)
@packages/core/src/theme/shadows.ts (platformShadow helper)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix icon color defaults in UI components</name>
  <files>
    packages/registry/ui/calendar.tsx
    packages/registry/ui/tag-input.tsx
    packages/registry/ui/pagination.tsx
  </files>
  <action>
In each file, find all inline icon function components that have `color = '#000'` as a default parameter.

For EACH icon function:
1. Remove the `= '#000'` default from the parameter
2. Inside the function body, add `const { colors } = useTheme();` (if not already present — check if the component or a parent scope already calls useTheme)
3. Add `const finalColor = color ?? colors.foreground;`
4. Replace all usages of `color` in the icon's JSX with `finalColor`

**Pattern:**
```tsx
// BEFORE
function ChevronIcon({ size = 24, color = '#000' }: { size?: number; color?: string }) {
  return <Svg stroke={color}>...</Svg>;
}

// AFTER
function ChevronIcon({ size = 24, color }: { size?: number; color?: string }) {
  const { colors } = useTheme();
  const finalColor = color ?? colors.foreground;
  return <Svg stroke={finalColor}>...</Svg>;
}
```

**Important:**
- If `useTheme` is not already imported, add the import: `import { useTheme } from '@metacells/mcellui-core';`
- If the icon is inside a component that already calls `useTheme()`, you can reference the parent's `colors` instead of calling `useTheme()` again — BUT only if the icon function is NOT a standalone function component (check if it's defined at module scope vs inside another component).
- calendar.tsx has 2 icons (lines ~53, ~61)
- tag-input.tsx has 1 icon (line ~53)
- pagination.tsx has 2 icons (lines ~56, ~64)
  </action>
  <verify>
Run: `grep -n "color = '#000'" packages/registry/ui/calendar.tsx packages/registry/ui/tag-input.tsx packages/registry/ui/pagination.tsx`
Expected: No matches (all hardcoded defaults removed).

Run: `grep -n "colors.foreground" packages/registry/ui/calendar.tsx packages/registry/ui/tag-input.tsx packages/registry/ui/pagination.tsx`
Expected: At least 5 matches (one per icon component).
  </verify>
  <done>All icon components in calendar.tsx, tag-input.tsx, and pagination.tsx use `colors.foreground` as default instead of `#000`. Passing an explicit `color` prop still works correctly.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate custom shadows to platformShadow() in UI components</name>
  <files>
    packages/registry/ui/tag-input.tsx
    packages/registry/ui/tooltip.tsx
    packages/registry/ui/segmented-control.tsx
    packages/registry/ui/popover.tsx
    packages/registry/ui/tabs.tsx
    packages/registry/ui/slider.tsx
  </files>
  <action>
In each file, find custom shadow objects (patterns like `shadowColor: '#000', shadowOpacity: X, shadowOffset: {...}, shadowRadius: X`) and replace them with `platformShadow()`.

**Shadow opacity mapping:**
- opacity 0.05-0.08 → `platformShadow('sm')`
- opacity 0.1-0.15 → `platformShadow('sm')` (conservative — these are subtle shadows)
- opacity 0.2+ → `platformShadow('md')`

**For each file:**

1. **tag-input.tsx** (line ~436-438): Replace `shadowColor: '#000', shadowOpacity: 0.1, shadowOffset/shadowRadius` with spread of `platformShadow('sm')`. Ensure `platformShadow` is destructured from `useTheme()`.

2. **tooltip.tsx** (line ~342-344): Replace shadow with `platformShadow('md')` (opacity was 0.2).

3. **segmented-control.tsx** (line ~213-215): Replace shadow with `platformShadow('sm')` (opacity was 0.08).

4. **popover.tsx** (line ~299-301): Replace shadow with `platformShadow('md')` (opacity was 0.15).

5. **tabs.tsx** (line ~342-344): Replace shadow with `platformShadow('sm')` (opacity was 0.05).

6. **slider.tsx** (line ~299-303): Replace shadow with `platformShadow('sm')` (opacity was 0.1).

**Pattern:**
```tsx
// BEFORE (in StyleSheet or inline style)
{
  shadowColor: '#000',
  shadowOpacity: 0.1,
  shadowOffset: { width: 0, height: 1 },
  shadowRadius: 3,
  elevation: 2,
}

// AFTER (spread platformShadow into style)
{
  ...platformShadow('sm'),
}
```

**Important:**
- If the shadow is in a `StyleSheet.create()` call, you cannot spread there. Instead, apply `platformShadow()` as an inline style or via `style={[styles.foo, platformShadow('sm')]}`.
- Ensure `platformShadow` is destructured from `useTheme()`: `const { platformShadow } = useTheme();`
- Remove any standalone `elevation: N` property that was part of the custom shadow (platformShadow handles this).
- If `useTheme()` is already called in the component, just add `platformShadow` to the destructuring.
  </action>
  <verify>
Run: `grep -rn "shadowColor.*#000" packages/registry/ui/tag-input.tsx packages/registry/ui/tooltip.tsx packages/registry/ui/segmented-control.tsx packages/registry/ui/popover.tsx packages/registry/ui/tabs.tsx packages/registry/ui/slider.tsx`
Expected: No matches (all custom shadows removed).

Run: `grep -n "platformShadow" packages/registry/ui/tag-input.tsx packages/registry/ui/tooltip.tsx packages/registry/ui/segmented-control.tsx packages/registry/ui/popover.tsx packages/registry/ui/tabs.tsx packages/registry/ui/slider.tsx`
Expected: At least 6 matches (one per component).
  </verify>
  <done>All 6 UI components use `platformShadow('sm')` or `platformShadow('md')` instead of custom shadow objects. No `shadowColor: '#000'` remains in these files.</done>
</task>

</tasks>

<verification>
1. `grep -rn "color = '#000'" packages/registry/ui/calendar.tsx packages/registry/ui/tag-input.tsx packages/registry/ui/pagination.tsx` → 0 matches
2. `grep -rn "shadowColor.*#000" packages/registry/ui/tag-input.tsx packages/registry/ui/tooltip.tsx packages/registry/ui/segmented-control.tsx packages/registry/ui/popover.tsx packages/registry/ui/tabs.tsx packages/registry/ui/slider.tsx` → 0 matches
3. `grep -rn "platformShadow" packages/registry/ui/tag-input.tsx packages/registry/ui/tooltip.tsx packages/registry/ui/segmented-control.tsx packages/registry/ui/popover.tsx packages/registry/ui/tabs.tsx packages/registry/ui/slider.tsx` → 6+ matches
4. TypeScript compilation passes: `npx tsc --noEmit` in registry package (or at least no new errors)
</verification>

<success_criteria>
- Zero `color = '#000'` defaults in calendar, tag-input, pagination UI files
- Zero custom shadow objects in the 6 UI files
- All icons default to `colors.foreground` via useTheme()
- All shadows use `platformShadow('sm')` or `platformShadow('md')`
</success_criteria>

<output>
After completion, create `.planning/phases/19-critical-color-api-fixes/19-01-SUMMARY.md`
</output>

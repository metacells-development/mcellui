---
phase: 19-critical-color-api-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/registry/ui/toast.tsx
  - packages/registry/ui/action-sheet.tsx
  - packages/registry/ui/datetime-picker.tsx
  - packages/registry/ui/image-gallery.tsx
  - packages/registry/ui/card.tsx
  - packages/registry/ui/swipeable-row.tsx
  - packages/registry/ui/avatar-stack.tsx
  - packages/registry/ui/rating.tsx
autonomous: true

must_haves:
  truths:
    - "All RGBA overlays in UI components use colors.overlay or colors.scrim instead of hardcoded rgba()"
    - "All hardcoded #fff/#000/#ffffff text colors in UI components use semantic tokens"
    - "All hardcoded hex colors for UI elements (rating stars, avatar borders) use semantic tokens"
    - "Card image overlay text uses colors.primaryForeground instead of #ffffff"
  artifacts:
    - path: "packages/registry/ui/card.tsx"
      provides: "Semantic overlay and text colors"
      contains: "colors.overlay"
    - path: "packages/registry/ui/action-sheet.tsx"
      provides: "Semantic overlay backdrop"
      contains: "colors.overlay"
    - path: "packages/registry/ui/rating.tsx"
      provides: "Semantic star color"
      contains: "colors.warning"
    - path: "packages/registry/ui/avatar-stack.tsx"
      provides: "Semantic avatar border"
      contains: "colors.background"
  key_links:
    - from: "packages/registry/ui/*.tsx"
      to: "@metacells/mcellui-core"
      via: "useTheme() hook"
      pattern: "const \\{ colors \\} = useTheme"
---

<objective>
Fix RGBA overlay colors and hardcoded hex values in UI components.

Purpose: Hardcoded RGBA overlays don't adapt to dark mode (opacity needs to increase). Hardcoded hex text colors (#fff, #000) become invisible when themes change. These must use semantic tokens for full theming support.

Output: 8 UI component files using semantic tokens for overlays, text, and element colors.
</objective>

<execution_context>
@/Users/johanneschristler/.claude/get-shit-done/workflows/execute-plan.md
@/Users/johanneschristler/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-critical-color-api-fixes/19-RESEARCH.md

Key reference:
@packages/core/src/theme/colors.ts (semantic color tokens — overlay, scrim, foreground, etc.)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix RGBA overlays in UI components</name>
  <files>
    packages/registry/ui/toast.tsx
    packages/registry/ui/action-sheet.tsx
    packages/registry/ui/datetime-picker.tsx
    packages/registry/ui/image-gallery.tsx
    packages/registry/ui/card.tsx
  </files>
  <action>
Replace all hardcoded `rgba()` values with semantic color tokens from `useTheme()`.

**Token mapping:**
- `rgba(0,0,0,0.5)` → `colors.overlay` (full-screen modal/dialog backdrops)
- `rgba(0,0,0,0.3)` or `rgba(0,0,0,0.4)` → `colors.scrim` (subtle dimming, image overlays)
- `rgba(255,255,255,0.2)` → `colors.backgroundElevated` (elevated surface, toast bg)
- `rgba(255,255,255,0.4)` → `colors.background` with appropriate context
- `rgba(255,255,255,0.7)` → `colors.background` with appropriate context
- `rgba(255,255,255,0.8)` → `colors.primaryForeground` (text on dark images)

**Per-file instructions:**

1. **toast.tsx** (line ~272): Replace `rgba(255,255,255,0.2)` → `colors.backgroundElevated`

2. **action-sheet.tsx** (line ~364): Replace `rgba(0,0,0,0.5)` → `colors.overlay`

3. **datetime-picker.tsx** (line ~540): Replace `rgba(0,0,0,0.5)` → `colors.overlay`

4. **image-gallery.tsx** (line ~336): Replace `rgba(255,255,255,0.4)` → Use `colors.background` (for close button background on dark images). Note: If it needs transparency, consider creating a close button with `colors.backgroundElevated`.

5. **card.tsx** — Multiple fixes:
   - Line ~408: Replace `rgba(255,255,255,0.8)` for image card title text → `colors.primaryForeground`
   - Line ~621: Replace `rgba(0,0,0,0.4)` for image overlay → `colors.scrim`
   - Lines ~637, ~644: Replace `rgba(0,0,0,0.3)` text shadows → Remove text shadows OR use `colors.scrim` for textShadowColor

**Important:**
- Ensure `colors` is destructured from `useTheme()` in each component. Most already do this.
- For text shadows in card.tsx, if removing seems too aggressive, replace the color with `colors.scrim` but keep the shadow offset/radius.
- For `image-gallery.tsx`, the white overlay is likely a close button on top of a dark image — `colors.backgroundElevated` with opacity is acceptable or just use the solid token.
  </action>
  <verify>
Run: `grep -rn "rgba(" packages/registry/ui/toast.tsx packages/registry/ui/action-sheet.tsx packages/registry/ui/datetime-picker.tsx packages/registry/ui/image-gallery.tsx packages/registry/ui/card.tsx`
Expected: Zero matches for the specific hardcoded rgba() values listed above. (Note: if any OTHER rgba values exist that were not in the research, leave them — they may be intentional or covered by other phases.)
  </verify>
  <done>All hardcoded RGBA overlay values in these 5 UI files are replaced with semantic tokens. Dark mode overlays will now automatically use correct opacity.</done>
</task>

<task type="auto">
  <name>Task 2: Fix hardcoded hex colors in UI components</name>
  <files>
    packages/registry/ui/card.tsx
    packages/registry/ui/swipeable-row.tsx
    packages/registry/ui/avatar-stack.tsx
    packages/registry/ui/rating.tsx
  </files>
  <action>
Replace all hardcoded hex colors with semantic tokens.

**Per-file instructions:**

1. **card.tsx** (line ~403): Replace `color: '#ffffff'` (image card title text) → `color: colors.primaryForeground`

2. **swipeable-row.tsx** (line ~334): Replace `#fff` (default text color for swipe actions) → `colors.primaryForeground`
   - Context: This is text on colored swipe action buttons (delete, archive, etc.), so `primaryForeground` is correct (white-on-color).

3. **avatar-stack.tsx**:
   - Line ~175: Replace `#ffffff` (avatar border color) → `colors.background` or `colors.card`
   - Line ~235: Replace `#ffffff` (overflow indicator border) → `colors.background` or `colors.card`
   - The border separates overlapping avatars, so it should match the background behind the stack.

4. **rating.tsx** (line ~223): Replace `#F59E0B` (amber star color) → `colors.warning`
   - The warning token is amber/yellow in all theme presets, making it semantically correct for star ratings.

**Important:**
- DO NOT change colors in stories.tsx (Instagram gradient — intentional brand colors).
- card.tsx may already have been partially fixed in Task 1 — avoid double-editing line 403/408 (the rgba fix and hex fix may overlap). Check if the rgba fix already handled the text color. If line 403 has `#ffffff` AND line 408 has `rgba(255,255,255,0.8)`, they are likely separate elements — fix both.
  </action>
  <verify>
Run: `grep -n "'#ffffff'\|'#fff'\|'#F59E0B'" packages/registry/ui/card.tsx packages/registry/ui/swipeable-row.tsx packages/registry/ui/avatar-stack.tsx packages/registry/ui/rating.tsx`
Expected: Zero matches.

Run: `grep -n "colors.primaryForeground\|colors.background\|colors.warning" packages/registry/ui/card.tsx packages/registry/ui/swipeable-row.tsx packages/registry/ui/avatar-stack.tsx packages/registry/ui/rating.tsx`
Expected: At least 5 matches.
  </verify>
  <done>All hardcoded hex colors (#ffffff, #fff, #F59E0B) in card, swipeable-row, avatar-stack, and rating are replaced with semantic tokens. Theming will now work correctly for these elements.</done>
</task>

</tasks>

<verification>
1. `grep -rn "rgba(0,0,0" packages/registry/ui/toast.tsx packages/registry/ui/action-sheet.tsx packages/registry/ui/datetime-picker.tsx packages/registry/ui/card.tsx` → 0 matches for overlay values
2. `grep -rn "rgba(255,255,255" packages/registry/ui/toast.tsx packages/registry/ui/image-gallery.tsx packages/registry/ui/card.tsx` → 0 matches
3. `grep -rn "'#ffffff'\|'#fff'\|'#F59E0B'" packages/registry/ui/card.tsx packages/registry/ui/swipeable-row.tsx packages/registry/ui/avatar-stack.tsx packages/registry/ui/rating.tsx` → 0 matches
4. `grep -rn "colors.overlay\|colors.scrim\|colors.primaryForeground\|colors.warning" packages/registry/ui/toast.tsx packages/registry/ui/action-sheet.tsx packages/registry/ui/datetime-picker.tsx packages/registry/ui/image-gallery.tsx packages/registry/ui/card.tsx packages/registry/ui/swipeable-row.tsx packages/registry/ui/avatar-stack.tsx packages/registry/ui/rating.tsx` → 8+ matches
</verification>

<success_criteria>
- Zero hardcoded rgba() overlay values in the 5 UI component files
- Zero hardcoded #ffffff/#fff/#F59E0B in the 4 UI component files
- All replaced with semantic tokens (colors.overlay, colors.scrim, colors.primaryForeground, colors.warning, colors.background)
- stories.tsx Instagram gradient colors NOT changed
</success_criteria>

<output>
After completion, create `.planning/phases/19-critical-color-api-fixes/19-02-SUMMARY.md`
</output>
